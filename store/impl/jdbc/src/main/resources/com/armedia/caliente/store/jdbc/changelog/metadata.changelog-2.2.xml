<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="caliente-jdbc" id="2.2">
		<preConditions>
			<changeSetExecuted id="2.0" author="caliente-jdbc" changeLogFile="metadata.changelog.deltas.xml"/>
		</preConditions>

		<!-- **************************************** -->
		<!-- Fix the property names                   -->
		<!-- **************************************** -->
		<sql>
			update cmf_property set name = 'cmf:users_with_default_acl' where name = 'usersWithDefaultACL'
		</sql>
		<sql>
			update cmf_property set name = 'cmf:users_with_default_group' where name = 'usersWithDefaultGroup'
		</sql>
		<sql>
			update cmf_property set name = 'cmf:users_with_default_folder' where name = 'usersWithDefaultFolder'
		</sql>
		<sql>
			update cmf_property set name = 'cmf:users_default_folder_paths' where name = 'usersDefaultFolderPaths'
		</sql>
		<sql>
			update cmf_property set name = 'cmf:groups_with_default_folder' where name = 'groupsWithDefaultFolder'
		</sql>

		<!-- **************************************** -->
		<!-- Add the supplementary index to the tree  -->
		<!-- **************************************** -->
		<createIndex tableName="cmf_object_tree" indexName="idx_cmf_object_tree_parent" unique="true">
			<column name="parent_id" />
			<column name="object_id" />
		</createIndex>

		<!-- **************************************** -->
		<!-- Add the requirement tracker              -->
		<!-- **************************************** -->
		<createTable tableName="cmf_requirement">
			<column name="object_id" type="varchar(96)" remarks="The primary object">
				<constraints nullable="false" />
			</column>
			<column name="requirement_id" type="varchar(96)" remarks="The required object">
				<constraints nullable="false" />
			</column>
			<column name="requirement_number" type="bigint" remarks="The ordinal number of the requirement">
				<constraints nullable="false" unique="true"/>
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_requirement" columnNames="object_id, requirement_id" />
		<addForeignKeyConstraint constraintName="fk_cmf_requirement_object"
			baseTableName="cmf_requirement" baseColumnNames="object_id"
			referencedTableName="cmf_export_plan" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<addForeignKeyConstraint constraintName="fk_cmf_requirement_requirement"
			baseTableName="cmf_requirement" baseColumnNames="requirement_id"
			referencedTableName="cmf_export_plan" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<createIndex tableName="cmf_requirement" indexName="idx_cmf_requirement_number" unique="true">
			<column name="requirement_number" />
		</createIndex>
		<createIndex tableName="cmf_requirement" indexName="idx_cmf_requirement_order" unique="true">
			<column name="object_id" />
			<column name="requirement_number" />
		</createIndex>
		<createIndex tableName="cmf_requirement" indexName="idx_cmf_requirement_order_rev" unique="true">
			<column name="requirement_id" />
			<column name="requirement_number" />
		</createIndex>
		<createIndex tableName="cmf_requirement" indexName="idx_cmf_requirement_reverse" unique="true">
			<column name="requirement_id" />
			<column name="object_id" />
			<column name="requirement_number" />
		</createIndex>
		<addAutoIncrement tableName="cmf_requirement" columnName="requirement_number" columnDataType="bigint" startWith="1" incrementBy="1"/>

		<!-- **************************************** -->
		<!-- Add the import plan                      -->
		<!-- **************************************** -->
		<createTable tableName="cmf_import_plan">
			<column name="object_id" type="varchar(96)" remarks="The primary object">
				<constraints nullable="false" />
			</column>
			<column name="status" type="varchar(256)" remarks="The import status">
				<constraints nullable="false" />
			</column>
			<column name="info" type="text" remarks="Extra information">
				<constraints nullable="true" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_import_plan" columnNames="object_id" />
		<addForeignKeyConstraint constraintName="fk_cmf_import_plan_object"
			baseTableName="cmf_import_plan" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<createIndex tableName="cmf_import_plan" indexName="idx_cmf_import_plan_status" unique="false">
			<column name="status" />
			<column name="object_id" />
		</createIndex>
	</changeSet>
</databaseChangeLog>