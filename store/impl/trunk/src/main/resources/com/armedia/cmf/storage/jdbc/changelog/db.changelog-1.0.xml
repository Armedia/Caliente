<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
	<changeSet author="cmf" id="1001">
    	<preConditions onFail="MARK_RAN">
    		<not>
	    		<changeSetExecuted id="1" author="master" changeLogFile="com/delta/cmsmf/datastore/changelog/db.changelog-1.0.xml"/>
    		</not>
	    </preConditions>

		<!-- The CMSMF info table -->
		<createTable tableName="cmf_info">
			<column name="name" type="varchar(64)" remarks="The name of the property being stored">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The property's data type">
				<constraints nullable="false" />
			</column>
			<column name="value" type="text" remarks="The property's value">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_info" columnNames="name" />

		<!-- The export plan table -->
		<createTable tableName="cmf_export_plan">
			<column name="object_id" type="varchar(32)" remarks="The object which is to be exported">
				<constraints nullable="false" />
			</column>
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="traversed" type="boolean" remarks="A flag indicating whether the object has been exported or not">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_export_plan" columnNames="object_id" />
		<addDefaultValue tableName="cmf_export_plan" columnName="traversed" defaultValueBoolean="false" />
		<createIndex tableName="cmf_export_plan" indexName="idx_cmf_export_plan">
			<column name="object_type" />
			<column name="traversed" />
			<column name="object_id" />
		</createIndex>

		<!-- The main objects table -->
		<createTable tableName="cmf_object" remarks="The CMS objects">
			<column name="object_id" type="varchar(32)" remarks="The object's ID">
				<constraints nullable="false" />
			</column>
			<column name="search_key" type="varchar(1024)" remarks="The object's Search Key">
				<constraints nullable="false" />
			</column>
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="object_subtype" type="varchar(32)" remarks="The exact type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="batch_id" type="varchar(32)" remarks="The batch identifier that links multiple related objects together to be imported in order">
				<constraints nullable="false" unique="false"/>
			</column>
			<column name="acl_domain" type="varchar(96)" remarks="The ACL's domain">
				<constraints nullable="true" />
			</column>
			<column name="acl_name" type="varchar(96)" remarks="The ACL's name">
				<constraints nullable="true" />
			</column>
			<column name="object_number" type="long" remarks="The export ordinal number of the object (import will be done in this order as well)">
				<constraints nullable="false" unique="true"/>
			</column>
			<column name="object_label" type="text" remarks="A label to quickly identify the object">
				<constraints nullable="true" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_object" columnNames="object_id" />
		<addForeignKeyConstraint constraintName="fk_cmf_object_plan"
			baseTableName="cmf_object" baseColumnNames="object_id"
			referencedTableName="cmf_export_plan" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_number" unique="true">
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_type" unique="true">
			<column name="object_type" />
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_subtype_batch" unique="true">
			<column name="object_subtype" />
			<column name="batch_id" />
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_search_key" unique="true">
			<column name="object_type" />
			<column name="object_subtype" />
			<column name="search_key" />
		</createIndex>
		<addAutoIncrement tableName="cmf_object" columnName="object_number" columnDataType="long" startWith="1" incrementBy="1"/>

		<!-- The ACL  table -->
		<createTable tableName="cmf_acl">
			<column name="object_id" type="varchar(32)" remarks="The object the ACL is for">
				<constraints nullable="false" />
			</column>
			<column name="principal" type="varchar(96)" remarks="The principal this entry is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(96)" remarks="The permission's name">
				<constraints nullable="false" />
			</column>
			<column name="type" type="varchar(32)" remarks="The permission's type">
				<constraints nullable="false" />
			</column>
			<column name="grant" type="boolean" remarks="Whether this is a permission grant (true) or a denial (false)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_acl" columnNames="object_id, principal, name, type" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl_object"
			baseTableName="cmf_acl" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />


		<!-- The attribute descriptor table -->
		<createTable tableName="cmf_attribute">
			<column name="object_id" type="varchar(32)" remarks="The object the attribute is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(32)" remarks="The attribute's name">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The attribute's data type">
				<constraints nullable="false" />
			</column>
			<column name="repeating" type="boolean" remarks="The flag indicating whether this is a single or repeating value attribute">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_attribute" columnNames="object_id, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_attribute_object"
			baseTableName="cmf_attribute" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The attribute values table -->
		<createTable tableName="cmf_attribute_value">
			<column name="object_id" type="varchar(32)" remarks="The object the attribute is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(32)" remarks="The attribute's name">
				<constraints nullable="false" />
			</column>
			<column name="value_number" type="integer" remarks="The value index for repeating values (always 0 for single-values)">
				<constraints nullable="false" />
			</column>
			<column name="null_value" type="boolean" remarks="Indicates whether this value is null">
				<constraints nullable="false" />
			</column>
			<column name="data" type="text" remarks="The actual string-encoded data"/>
		</createTable>
		<addPrimaryKey tableName="cmf_attribute_value"
			columnNames="object_id, name, value_number" />
		<addForeignKeyConstraint constraintName="fk_cmf_attribute_value_attribute"
			baseTableName="cmf_attribute_value" baseColumnNames="object_id, name"
			referencedTableName="cmf_attribute" referencedColumnNames="object_id, name"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The property descriptor table -->
		<createTable tableName="cmf_property">
			<column name="object_id" type="varchar(32)" remarks="The object the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(32)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The property's data type">
				<constraints nullable="false" />
			</column>
			<column name="repeating" type="boolean" remarks="The flag indicating whether this is a single or repeating value property">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_property" columnNames="object_id, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_property_object"
			baseTableName="cmf_property" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The property values table -->
		<createTable tableName="cmf_property_value">
			<column name="object_id" type="varchar(32)" remarks="The object the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(32)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="value_number" type="integer" remarks="The value index for repeating values (always 0 for single-values)">
				<constraints nullable="false" />
			</column>
			<column name="null_value" type="boolean" remarks="Indicates whether this value is null">
				<constraints nullable="false" />
			</column>
			<column name="data" type="text" remarks="The actual string-encoded data" />
		</createTable>
		<addPrimaryKey tableName="cmf_property_value"
			columnNames="object_id, name, value_number" />
		<addForeignKeyConstraint constraintName="fk_cmf_property_value_property"
			baseTableName="cmf_property_value" baseColumnNames="object_id, name"
			referencedTableName="cmf_property" referencedColumnNames="object_id, name"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The attribute mapping table -->
		<createTable tableName="cmf_mapper">
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(32)" remarks="The name of the attribute to map">
				<constraints nullable="false" />
			</column>
			<column name="source_value" type="varchar(32)" remarks="The value on the source CMS">
				<constraints nullable="false" />
			</column>
			<column name="target_value" type="varchar(32)" remarks="The value on the target CMS">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_mapper" columnNames="object_type, name, source_value" />
		<createIndex tableName="cmf_mapper" indexName="idx_cmf_mapper_reverse">
			<column name="object_type" />
			<column name="name" />
			<column name="target_value" />
		</createIndex>
	</changeSet>

	<!-- migrate metadata from CMSMF -->
	<changeSet author="cmf" id="1002">
    	<preConditions onFail="MARK_RAN">
    		<changeSetExecuted id="1" author="master" changeLogFile="com/delta/cmsmf/datastore/changelog/db.changelog-1.0.xml"/>
	    </preConditions>
	    <renameTable oldTableName="cmsmf_info" newTableName="cmf_info"/>
	    <renameTable oldTableName="dctm_export_plan" newTableName="cmf_export_plan"/>
	    <renameTable oldTableName="dctm_object" newTableName="cmf_object"/>
	    <renameTable oldTableName="dctm_attribute" newTableName="cmf_attribute"/>
	    <renameTable oldTableName="dctm_attribute_value" newTableName="cmf_attribute_value"/>
	    <renameTable oldTableName="dctm_property" newTableName="cmf_property"/>
	    <renameTable oldTableName="dctm_property_value" newTableName="cmf_property_value"/>
	    <renameTable oldTableName="dctm_mapper" newTableName="cmf_mapper"/>

		<!-- Create the qualifier records for any content that's already there from CMSMF -->
		<sql><![CDATA[
			insert into cmf_property
			select o.object_id, '${CONTENT_QUALIFIER}$', 'STRING', false
			  from cmf_object o
			 where o.object_type = 'CONTENT'
		]]></sql>
		<sql><![CDATA[
			insert into cmf_property_value
			select o.object_id, '${CONTENT_QUALIFIER}$', 0, substr(v.data, 17)
			  from cmf_object o, cmf_property_value v
			 where o.object_id = v.object_id
			   and o.object_type = 'CONTENT'
			   and v.name = 'fileSystemPath'
			   and v.value_number = 3
		]]></sql>

		<insert tableName="cmf_info">
			<column name="name" type="varchar(64)" value="strategy" />
			<column name="value" type="text" value="cmsmf-upgrade" />
		</insert>

		<rollback>
			<sql><![CDATA[
				delete from cmf_info where name = 'strategy'
			]]></sql>
			<sql><![CDATA[
				delete from cmf_property_value where name = '${CONTENT_QUALIFIER}$'
			]]></sql>
			<sql><![CDATA[
				delete from cmf_property where name = '${CONTENT_QUALIFIER}$'
			]]></sql>

		    <renameTable oldTableName="cmf_mapper" newTableName="dctm_mapper"/>
		    <renameTable oldTableName="cmf_property_value" newTableName="dctm_property_value"/>
		    <renameTable oldTableName="cmf_property" newTableName="dctm_property"/>
		    <renameTable oldTableName="cmf_attribute_value" newTableName="dctm_attribute_value"/>
		    <renameTable oldTableName="cmf_attribute" newTableName="dctm_attribute"/>
		    <renameTable oldTableName="cmf_object" newTableName="dctm_object"/>
		    <renameTable oldTableName="cmf_export_plan" newTableName="dctm_export_plan"/>
		    <renameTable oldTableName="cmf_info" newTableName="cmsmf_info"/>
		</rollback>
	</changeSet>

	<!-- make sure one of the above was executed (they're negated, so either-or) -->
	<changeSet author="cmf" id="1003">
    	<preConditions>
    		<or>
	    		<changeSetExecuted id="1001" author="cmf" changeLogFile="com/armedia/cmf/storage/jdbc/changelog/db.changelog-1.0.xml"/>
	    		<changeSetExecuted id="1002" author="cmf" changeLogFile="com/armedia/cmf/storage/jdbc/changelog/db.changelog-1.0.xml"/>
    		</or>
	    </preConditions>
	</changeSet>

	<changeSet author="cmf" id="1004">
    	<preConditions>
    		<or>
	    		<changeSetExecuted id="1001" author="cmf" changeLogFile="com/armedia/cmf/storage/jdbc/changelog/db.changelog-1.0.xml"/>
	    		<changeSetExecuted id="1002" author="cmf" changeLogFile="com/armedia/cmf/storage/jdbc/changelog/db.changelog-1.0.xml"/>
    		</or>
	    </preConditions>
		<sql dbms="mysql, oracle, h2"><![CDATA[
			alter table cmf_export_plan modify column object_id varchar(96);
			alter table cmf_object modify column object_id varchar(96);
			alter table cmf_object modify column batch_id varchar(96);
			alter table cmf_object modify column object_subtype varchar(64);
			alter table cmf_attribute modify column object_id varchar(96);
			alter table cmf_attribute modify column name varchar(64);
			alter table cmf_attribute modify column id varchar(96);
			alter table cmf_attribute_value modify column object_id varchar(96);
			alter table cmf_attribute_value modify column name varchar(64);
			alter table cmf_property modify column object_id varchar(96);
			alter table cmf_property modify column name varchar(64);
			alter table cmf_property_value modify column object_id varchar(96);
			alter table cmf_property_value modify column name varchar(64);
		]]></sql>
		<sql dbms="postgresql"><![CDATA[
			alter table cmf_export_plan alter column object_id type varchar(96);
			alter table cmf_object alter column object_id type varchar(96);
			alter table cmf_object alter column batch_id type varchar(96);
			alter table cmf_object alter column object_subtype type varchar(64);
			alter table cmf_attribute alter column object_id type varchar(96);
			alter table cmf_attribute alter column name type varchar(64);
			alter table cmf_attribute alter column id type varchar(96);
			alter table cmf_attribute_value alter column object_id type varchar(96);
			alter table cmf_attribute_value alter column name type varchar(64);
			alter table cmf_property alter column object_id type varchar(96);
			alter table cmf_property alter column name type varchar(64);
			alter table cmf_property_value alter column object_id type varchar(96);
			alter table cmf_property_value alter column name type varchar(64);
		]]></sql>

		<rollback>
			<sql dbms="mysql, oracle, h2"><![CDATA[
				alter table cmf_export_plan modify column object_id varchar(32);
				alter table cmf_object modify column object_id varchar(32);
				alter table cmf_object modify column batch_id varchar(32);
				alter table cmf_object modify column object_subtype varchar(32);
				alter table cmf_attribute modify column object_id varchar(32);
				alter table cmf_attribute modify column name varchar(32);
				alter table cmf_attribute modify column id varchar(32);
				alter table cmf_attribute_value modify column object_id varchar(32);
				alter table cmf_attribute_value modify column name varchar(32);
				alter table cmf_property modify column object_id varchar(32);
				alter table cmf_property modify column name varchar(32);
				alter table cmf_property_value modify column object_id varchar(32);
				alter table cmf_property_value modify column name varchar(32);
			]]></sql>
			<sql dbms="postgresql"><![CDATA[
				alter table cmf_export_plan alter column object_id type varchar(32);
				alter table cmf_object alter column object_id type varchar(32);
				alter table cmf_object alter column batch_id type varchar(32);
				alter table cmf_object alter column object_subtype type varchar(32);
				alter table cmf_attribute alter column object_id type varchar(32);
				alter table cmf_attribute alter column name type varchar(32);
				alter table cmf_attribute alter column id type varchar(32);
				alter table cmf_attribute_value alter column object_id type varchar(32);
				alter table cmf_attribute_value alter column name type varchar(32);
				alter table cmf_property alter column object_id type varchar(32);
				alter table cmf_property alter column name type varchar(32);
				alter table cmf_property_value alter column object_id type varchar(32);
				alter table cmf_property_value alter column name type varchar(32);
			]]></sql>
		</rollback>
	</changeSet>
</databaseChangeLog>