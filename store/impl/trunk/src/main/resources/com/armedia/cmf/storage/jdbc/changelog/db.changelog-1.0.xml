<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
	<changeSet author="cmf" id="1001">
		<preConditions onFail="MARK_RAN">
			<not>
				<changeSetExecuted id="1" author="master" changeLogFile="com/delta/cmsmf/datastore/changelog/db.changelog-1.0.xml"/>
			</not>
		</preConditions>

		<!-- The CMSMF info table -->
		<createTable tableName="cmf_info">
			<column name="name" type="varchar(64)" remarks="The name of the property being stored">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The property's data type">
				<constraints nullable="false" />
			</column>
			<column name="value" type="text" remarks="The property's value">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_info" columnNames="name" />

		<!-- The export plan table -->
		<createTable tableName="cmf_export_plan">
			<column name="object_id" type="varchar(96)" remarks="The object which is to be exported">
				<constraints nullable="false" />
			</column>
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="traversed" type="boolean" remarks="A flag indicating whether the object has been exported or not">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_export_plan" columnNames="object_id" />
		<addDefaultValue tableName="cmf_export_plan" columnName="traversed" defaultValueBoolean="false" />
		<createIndex tableName="cmf_export_plan" indexName="idx_cmf_export_plan">
			<column name="object_type" />
			<column name="traversed" />
			<column name="object_id" />
		</createIndex>

		<!-- The ACL table -->
		<createTable tableName="cmf_acl" remarks="The ACLs for the CMS objects">
			<column name="acl_id" type="varchar(96)" remarks="The ACL's ID">
				<constraints nullable="false" />
			</column>
			<column name="source_object_id" type="varchar(96)" remarks="The source object that caused this ACL to be added">
				<constraints nullable="false" />
			</column>
			<column name="source_object_type" type="varchar(32)" remarks="The source object's type">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_acl" columnNames="acl_id" />
		<createIndex tableName="cmf_acl" indexName="idx_cmf_source_object" unique="true">
			<column name="source_object_id" />
		</createIndex>

		<!-- The ACL accessors table -->
		<createTable tableName="cmf_acl_accessor" remarks="The ACL accessors">
			<column name="acl_id" type="varchar(96)" remarks="The ACL's ID">
				<constraints nullable="false" />
			</column>
			<column name="accessor_id" type="bigint" remarks="The ACL accessor's ID">
				<constraints nullable="false" unique="false"/>
			</column>
			<column name="accessor_type" type="varchar(32)" remarks="The accessor's type">
				<constraints nullable="false" />
			</column>
			<column name="accessor_name" type="varchar(128)" remarks="The accessor's name">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_acl_accessor" columnNames="acl_id, accessor_id" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl_accessor_acl"
			baseTableName="cmf_acl_accessor" baseColumnNames="acl_id"
			referencedTableName="cmf_acl" referencedColumnNames="acl_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The ACL permissions table -->
		<createTable tableName="cmf_acl_permission" remarks="The ACL permissions">
			<column name="acl_id" type="varchar(96)" remarks="The ACL's ID">
				<constraints nullable="false" />
			</column>
			<column name="accessor_id" type="bigint" remarks="The ACL accessor's ID">
				<constraints nullable="false" />
			</column>
			<column name="permission_type" type="varchar(64)" remarks="The permission's type">
				<constraints nullable="false" />
			</column>
			<column name="permission_name" type="varchar(96)" remarks="The permission's name">
				<constraints nullable="false" />
			</column>
			<column name="granted" type="boolean" remarks="A flag indicating whether the permission is granted or revoked">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_acl_permission" columnNames="acl_id, accessor_id, permission_type, permission_name" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl_permission_accessor"
			baseTableName="cmf_acl_permission" baseColumnNames="acl_id, accessor_id"
			referencedTableName="cmf_acl_accessor" referencedColumnNames="acl_id, accessor_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The ACL property descriptor table -->
		<createTable tableName="cmf_acl_property">
			<column name="acl_id" type="varchar(96)" remarks="The ACL the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The property's data type">
				<constraints nullable="false" />
			</column>
			<column name="repeating" type="boolean" remarks="The flag indicating whether this is a single or repeating value property">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_acl_property" columnNames="acl_id, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl_property_acl"
			baseTableName="cmf_acl_property" baseColumnNames="acl_id"
			referencedTableName="cmf_acl" referencedColumnNames="acl_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The ACL property values table -->
		<createTable tableName="cmf_acl_property_value">
			<column name="acl_id" type="varchar(96)" remarks="The ACL the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="value_number" type="integer" remarks="The value index for repeating values (always 0 for single-values)">
				<constraints nullable="false" />
			</column>
			<column name="null_value" type="boolean" remarks="Indicates whether this value is null">
				<constraints nullable="false" />
			</column>
			<column name="data" type="text" remarks="The actual string-encoded data" />
		</createTable>
		<addPrimaryKey tableName="cmf_acl_property_value"
			columnNames="acl_id, name, value_number" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl_property_value_property"
			baseTableName="cmf_acl_property_value" baseColumnNames="acl_id, name"
			referencedTableName="cmf_acl_property" referencedColumnNames="acl_id, name"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The main objects table -->
		<createTable tableName="cmf_object" remarks="The CMS objects">
			<column name="object_id" type="varchar(96)" remarks="The object's ID">
				<constraints nullable="false" />
			</column>
			<column name="search_key" type="varchar(1024)" remarks="The object's Search Key">
				<constraints nullable="false" />
			</column>
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="object_subtype" type="varchar(64)" remarks="The exact type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="batch_id" type="varchar(96)" remarks="The batch identifier that links multiple related objects together to be imported in order">
				<constraints nullable="false" unique="false"/>
			</column>
			<column name="object_number" type="bigint" remarks="The export ordinal number of the object (import will be done in this order as well)">
				<constraints nullable="false" unique="true"/>
			</column>
			<column name="object_label" type="text" remarks="A label to quickly identify the object">
				<constraints nullable="false" />
			</column>
			<column name="acl_id" type="varchar(96)" remarks="The object's ACL's ID">
				<constraints nullable="true" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_object" columnNames="object_id" />
		<addForeignKeyConstraint constraintName="fk_cmf_object_plan"
			baseTableName="cmf_object" baseColumnNames="object_id"
			referencedTableName="cmf_export_plan" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<addForeignKeyConstraint constraintName="fk_cmf_acl"
			baseTableName="cmf_object" baseColumnNames="acl_id"
			referencedTableName="cmf_acl" referencedColumnNames="acl_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_number" unique="true">
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_type" unique="true">
			<column name="object_type" />
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_subtype_batch" unique="true">
			<column name="object_subtype" />
			<column name="batch_id" />
			<column name="object_number" />
		</createIndex>
		<createIndex tableName="cmf_object" indexName="idx_cmf_object_search_key" unique="true">
			<column name="object_type" />
			<column name="object_subtype" />
			<column name="search_key" />
		</createIndex>
		<addAutoIncrement tableName="cmf_object" columnName="object_number" columnDataType="bigint" startWith="1" incrementBy="1"/>

		<!-- The attribute descriptor table -->
		<createTable tableName="cmf_attribute">
			<column name="object_id" type="varchar(96)" remarks="The object the attribute is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The attribute's name">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The attribute's data type">
				<constraints nullable="false" />
			</column>
			<column name="id" type="varchar(96)" remarks="The attribute's id">
				<constraints nullable="false" />
			</column>
			<column name="length" type="integer" remarks="The maximum length of stored values">
				<constraints nullable="false" />
			</column>
			<column name="qualifiable" type="boolean" remarks="The flag indicating whether the attriute is qualifiable">
				<constraints nullable="false" />
			</column>
			<column name="repeating" type="boolean" remarks="The flag indicating whether this is a single or repeating value attribute">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_attribute" columnNames="object_id, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_attribute_object"
			baseTableName="cmf_attribute" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The attribute values table -->
		<createTable tableName="cmf_attribute_value">
			<column name="object_id" type="varchar(96)" remarks="The object the attribute is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The attribute's name">
				<constraints nullable="false" />
			</column>
			<column name="value_number" type="integer" remarks="The value index for repeating values (always 0 for single-values)">
				<constraints nullable="false" />
			</column>
			<column name="null_value" type="boolean" remarks="Indicates whether this value is null">
				<constraints nullable="false" />
			</column>
			<column name="data" type="text" remarks="The actual string-encoded data"/>
		</createTable>
		<addPrimaryKey tableName="cmf_attribute_value"
			columnNames="object_id, name, value_number" />
		<addForeignKeyConstraint constraintName="fk_cmf_attribute_value_attribute"
			baseTableName="cmf_attribute_value" baseColumnNames="object_id, name"
			referencedTableName="cmf_attribute" referencedColumnNames="object_id, name"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The property descriptor table -->
		<createTable tableName="cmf_property">
			<column name="object_id" type="varchar(96)" remarks="The object the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="data_type" type="varchar(32)" remarks="The property's data type">
				<constraints nullable="false" />
			</column>
			<column name="repeating" type="boolean" remarks="The flag indicating whether this is a single or repeating value property">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_property" columnNames="object_id, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_property_object"
			baseTableName="cmf_property" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The property values table -->
		<createTable tableName="cmf_property_value">
			<column name="object_id" type="varchar(96)" remarks="The object the property is for">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The property's name">
				<constraints nullable="false" />
			</column>
			<column name="value_number" type="integer" remarks="The value index for repeating values (always 0 for single-values)">
				<constraints nullable="false" />
			</column>
			<column name="null_value" type="boolean" remarks="Indicates whether this value is null">
				<constraints nullable="false" />
			</column>
			<column name="data" type="text" remarks="The actual string-encoded data" />
		</createTable>
		<addPrimaryKey tableName="cmf_property_value"
			columnNames="object_id, name, value_number" />
		<addForeignKeyConstraint constraintName="fk_cmf_property_value_property"
			baseTableName="cmf_property_value" baseColumnNames="object_id, name"
			referencedTableName="cmf_property" referencedColumnNames="object_id, name"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<!-- The attribute mapping table -->
		<createTable tableName="cmf_mapper">
			<column name="object_type" type="varchar(32)" remarks="The type of CMS object">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(64)" remarks="The name of the attribute to map">
				<constraints nullable="false" />
			</column>
			<column name="source_value" type="varchar(96)" remarks="The value on the source CMS">
				<constraints nullable="false" />
			</column>
			<column name="target_value" type="varchar(96)" remarks="The value on the target CMS">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey tableName="cmf_mapper" columnNames="object_type, name, source_value" />
		<createIndex tableName="cmf_mapper" indexName="idx_cmf_mapper_reverse">
			<column name="object_type" />
			<column name="name" />
			<column name="target_value" />
		</createIndex>
	</changeSet>
</databaseChangeLog>