<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<changeSet author="cmf" id="1002">
    	<preConditions>
    		<changeSetExecuted id="1001" author="cmf" changeLogFile="com/armedia/cmf/storage/jdbc/changelog/db.changelog-1.0.xml"/>
	    </preConditions>

		<dropForeignKeyConstraint baseTableName="cmf_content_property" constraintName="fk_cmf_content_property_content"/>
		<dropPrimaryKey tableName="cmf_content_property" />
		<dropForeignKeyConstraint baseTableName="cmf_content" constraintName="fk_cmf_content_object"/>
		<dropPrimaryKey tableName="cmf_content" />

	    <addColumn tableName="cmf_content">
			<column name="modifier" type="varchar(16)" remarks="The content's rendition modifier" defaultValue="">
				<constraints nullable="false" />
			</column>
	    </addColumn>
	    <addColumn tableName="cmf_content_property">
			<column name="modifier" type="varchar(16)" remarks="The content's rendition modifier" defaultValue="">
				<constraints nullable="false" />
			</column>
	    </addColumn>

		<addPrimaryKey tableName="cmf_content" columnNames="object_id, rendition_id, rendition_page, modifier" />
		<addForeignKeyConstraint constraintName="fk_cmf_content_object"
			baseTableName="cmf_content" baseColumnNames="object_id"
			referencedTableName="cmf_object" referencedColumnNames="object_id"
			onDelete="CASCADE" onUpdate="CASCADE" />
		<addPrimaryKey tableName="cmf_content_property" columnNames="object_id, rendition_id, rendition_page, modifier, name" />
		<addForeignKeyConstraint constraintName="fk_cmf_content_property_content"
			baseTableName="cmf_content_property" baseColumnNames="object_id, rendition_id, rendition_page, modifier"
			referencedTableName="cmf_content" referencedColumnNames="object_id, rendition_id, rendition_page, modifier"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<sql>
			update cmf_content c
			   set c.modifier = (
			          select p.value
			            from cmf_content_property p
			           where c.object_id = p.object_id
			             and c.rendition_id = p.rendition_id
			             and c.rendition_page = p.rendition_page
			             and p.name = 'page_modifier'
			       )
		</sql>
	</changeSet>
</databaseChangeLog>